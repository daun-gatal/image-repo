.build_template:
  stage: build
  image: quay.io/buildah/stable
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_FORMAT: docker

  before_script:
    # Log in to GitLab container registry
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

  script:
    # Generate tag and image name
    - export IMAGE_TAG=$(date -u +"%Y%m%d%H%M")
    - export IMAGE_NAME="${CI_REGISTRY_IMAGE}/${SUBDIR}"
    - echo "ðŸ”§ Building $IMAGE_NAME with tag: $IMAGE_TAG"

    # Build image from subdir Dockerfile
    - buildah build -t "${IMAGE_NAME}:${IMAGE_TAG}" -t "${IMAGE_NAME}:latest" "${CI_PROJECT_DIR}/${SUBDIR}"

    # Push both tags
    - buildah push "${IMAGE_NAME}:${IMAGE_TAG}"
    - buildah push "${IMAGE_NAME}:latest"
  tags:
    - k8s