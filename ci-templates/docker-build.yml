# ======================================
# Lint Stage
# ======================================
.lint_dockerfile:
  stage: lint
  image: ubuntu:22.04

  before_script:
    - apt-get update -y
    - apt-get install -y wget ca-certificates
    - wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
    - chmod +x /usr/local/bin/hadolint

  script:
    - echo "üîç Running Hadolint on Dockerfile..."
    - hadolint --config "${CI_PROJECT_DIR}/.hadolint.yaml" "${CI_PROJECT_DIR}/${SUBDIR}/Dockerfile"

  tags:
    - k8s
  allow_failure: false

# ======================================
# Validate Stage
# ======================================
.validate_dockerfile:
  stage: validate
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - IMAGE="${CI_REGISTRY_IMAGE}/${SUBDIR}:${VERSION}"
    - echo "üß™ Validating Dockerfile for version ${VERSION}"
    - docker build --no-cache --build-arg VERSION=${VERSION} -t "${IMAGE}" "${CI_PROJECT_DIR}/${SUBDIR}"
    - echo "‚úÖ Dockerfile validation succeeded for version ${IMAGE}"
    # Save image for next job
    - echo "üì¶ Saving image for next stage..."
    - docker save "${IMAGE}" -o "${SUBDIR}-image.tar"
  artifacts:
    paths:
      - "${SUBDIR}-image.tar"
    expire_in: 1 hour
  tags:
    - k8s
  allow_failure: false

# ======================================
# Build & Push Stage
# ======================================
.build_and_push_template:
  stage: build_and_push
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    # Log in to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - IMAGE="${CI_REGISTRY_IMAGE}/${SUBDIR}:${VERSION}"
    # Load image from validate step
    - echo "üì• Loading prebuilt image..."
    - docker load -i "${SUBDIR}-image.tar"
    # Ensure image is properly tagged
    - docker tag "${IMAGE}" "${IMAGE}"
    - echo "üöÄ Pushing ${IMAGE}"
    - docker push "${IMAGE}"
  tags:
    - k8s
