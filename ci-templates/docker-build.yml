.build_template:
  image:
    name: gcr.io/kaniko-project/executor:latest
    entrypoint: [""]
  stage: build

  variables:
    DOCKER_CONFIG: /kaniko/.docker/

  script:
    # Configure Docker auth for Kaniko
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "$CI_REGISTRY": {
            "username": "$CI_REGISTRY_USER",
            "password": "$CI_REGISTRY_PASSWORD"
          }
        }
      }
      EOF

    # Generate timestamp tag (UTC)
    - export IMAGE_TAG=$(date -u +"%Y%m%d%H%M")

    # Run Kaniko build
    - /kaniko/executor
        --context ./$SUBDIR
        --dockerfile ./$SUBDIR/Dockerfile
        --destination $CI_REGISTRY_IMAGE:$SUBDIR-$IMAGE_TAG
        --destination $CI_REGISTRY_IMAGE:$SUBDIR-latest
        --snapshotMode=redo
        --single-snapshot
        --use-new-run
        --reproducible

  tags:
    - k8s
