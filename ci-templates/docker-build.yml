# ======================================
# Lint Stage
# ======================================
.lint_dockerfile:
  stage: lint
  image: ubuntu:22.04

  before_script:
    - apt-get update -y
    - apt-get install -y wget ca-certificates
    - wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
    - chmod +x /usr/local/bin/hadolint

  script:
    - echo "üîç Running Hadolint on Dockerfile..."
    - hadolint --config "${CI_PROJECT_DIR}/.hadolint.yaml" "${CI_PROJECT_DIR}/${SUBDIR}/Dockerfile"

  tags:
    - k8s
  allow_failure: false

# ======================================
# Validate Stage
# ======================================
.validate_dockerfile:
  stage: validate
  image: quay.io/buildah/stable
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_FORMAT: docker
    BUILDAH_ISOLATION: chroot
  script:
    # Run a dry-run build to validate build args and COPY paths
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - echo "üß™ Validating build for version ${VERSION}"
    - buildah bud --storage-driver="$STORAGE_DRIVER" --no-cache --build-arg VERSION=${VERSION} --layers=false -t "dryrun:${CI_COMMIT_SHA}" "${CI_PROJECT_DIR}/${SUBDIR}"

  tags:
    - k8s
  allow_failure: false

# ======================================
# Build & Push Stage
# ======================================
.build_and_push_template:
  stage: build_and_push
  image: quay.io/buildah/stable
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_FORMAT: docker
    BUILDAH_ISOLATION: chroot
  before_script:
    # Log in to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    # Read version and prepare image name
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - export TAG_VERSION="${VERSION}"
    - export IMAGE_NAME="${CI_REGISTRY_IMAGE}/${SUBDIR}"
    - echo "üî® Building ${IMAGE_NAME}:${TAG_VERSION}"

    # Build the image with both tags
    - buildah build --storage-driver="$STORAGE_DRIVER" --build-arg VERSION="${TAG_VERSION}" -t "${IMAGE_NAME}:${TAG_VERSION}" "${CI_PROJECT_DIR}/${SUBDIR}"

    # Push directly to GitLab registry
    - echo "üöÄ Pushing ${IMAGE_NAME}:${TAG_VERSION}"
    - buildah push "${IMAGE_NAME}:${TAG_VERSION}"
  tags:
    - k8s
