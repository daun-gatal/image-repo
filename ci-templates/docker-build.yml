# ======================================
# Lint Stage
# ======================================
.lint_dockerfile:
  stage: lint
  image: ubuntu:22.04

  before_script:
    - apt-get update -y
    - apt-get install -y wget ca-certificates
    - wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
    - chmod +x /usr/local/bin/hadolint

  script:
    - echo "üîç Running Hadolint on Dockerfile..."
    - hadolint --config "${CI_PROJECT_DIR}/.hadolint.yaml" "${CI_PROJECT_DIR}/${SUBDIR}/Dockerfile"

  tags:
    - k8s
  allow_failure: false

# ======================================
# Validate Stage
# ======================================
.validate_dockerfile:
  stage: validate
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - docker build --build-arg VERSION=$VERSION --no-cache -f "${CI_PROJECT_DIR}/${SUBDIR}/Dockerfile" "${CI_PROJECT_DIR}/${SUBDIR}"
  tags:
    - k8s
  allow_failure: false

# ======================================
# Build & Push Stage
# ======================================
.build_and_push_template:
  stage: build_and_push
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - VERSION=$(cat "${CI_PROJECT_DIR}/${SUBDIR}/VERSION")
    - IMAGE_NAME="${CI_REGISTRY_IMAGE}/${SUBDIR}"
    - echo "Building ${IMAGE_NAME}:${VERSION}"
    - docker build --build-arg VERSION="${VERSION}" -t "${IMAGE_NAME}:${VERSION}" "${CI_PROJECT_DIR}/${SUBDIR}"
    - docker push "${IMAGE_NAME}:${VERSION}"
  tags:
    - k8s

